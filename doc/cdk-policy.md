# CDK 実装方針

## 目次
- [CDK 実装方針](#cdk-実装方針)
  - [目次](#目次)
  - [ディレクトリ構成について](#ディレクトリ構成について)
    - [実装方針](#実装方針)
  - [環境分割について](#環境分割について)
    - [実装方針](#実装方針-1)
      - [環境パラメータの管理方法](#環境パラメータの管理方法)
      - [環境切替方法](#環境切替方法)
      - [プログラム上での実装ルール](#プログラム上での実装ルール)
  - [スタックの実装について](#スタックの実装について)
    - [実装方針](#実装方針-2)
      - [スタック分割方針](#スタック分割方針)
      - [プログラム上での実装ルール](#プログラム上での実装ルール-1)
  - [コンストラクトの実装について](#コンストラクトの実装について)
    - [実装方針](#実装方針-3)
      - [コンストラクト分割方針](#コンストラクト分割方針)
      - [プログラム上での実装ルール](#プログラム上での実装ルール-2)
  - [命名規則について](#命名規則について)
    - [実装方針](#実装方針-4)
      - [命名規則](#命名規則)
      - [プログラム上での実装ルール](#プログラム上での実装ルール-3)
  - [タグについて](#タグについて)
    - [実装方針](#実装方針-5)
      - [CTC\_Bill02\_System タグ](#ctc_bill02_system-タグ)
      - [Name タグ](#name-タグ)
  - [スタックのRemoval Policy /削除保護　](#スタックのremoval-policy-削除保護)
    - [実装方針](#実装方針-6)
  - [テストについて](#テストについて)
    - [実装方針](#実装方針-7)


## ディレクトリ構成について
本CDKプロジェクトにおけるディレクトリ構成について記載する。
### 実装方針
第一階層のみ記載。

| 階層 | ディレクトリ/ファイル | 説明                                                    |
| ---- | --------------------- | ------------------------------------------------------- |
| 1    | bin/                  | メインプログラムを配置                                  |
| 1    | dev-script/           | 開発・運用用のスクリプトを配置                          |
| 1    | doc/                  | ドキュメントを配置                                      |
| 1    | lib/                  | プログラム上で利用するCDKスタック・コンストラクトを配置 |
| 1    | test/                 | テストコードを配置                                      |
| 1    | utils/                | プログラム上で利用するヘルパー関数等のコードを配置      |
| 1    | .eslintignore         | eslint (静的コード解析)を無視するファイルを設定         |
| 1    | .eslintrc.json        | eslint (静的コード解析)の設定                           |
| 1    | .gitignore            | git管理しないファイルを設定                             |
| 1    | cdk.json              | cdkの設定や環境パラメータを管理                         |
| 1    | jest.config.js        | jest（単体テスト）パラメータを管理                      |
| 1    | package.json          | プログラムで利用するnodejsパッケージを管理              |
| 1    | README.md             | ドキュメントのトップページ                              |



## 環境分割について
本CDKプロジェクトにおける環境分割方針について記載する。
開発環境、本番環境といった多少のパラメータ差異がある同一システム環境を複数面用意する場合、環境毎パラメータの管理方法及び環境切替の方法を検討する必要がある。
CDKにおける代表的な手法として、それぞれ以下のような管理方法がある。

* 環境パラメータの管理方法
    1. 環境毎のスタックを実装する
    1. cdk.json 等のパラメータファイルに環境毎パラメータを管理する
    1. パラメータストア等に環境パラメータを格納し、実行時に読み込む

* 環境切替方法
    1. プロジェクト内に環境毎のディレクトリ、ファイルを作成し、作成する環境毎に実行対象を振り分ける
    1. cdk contextの仕組みを利用し、CDK Deployコマンド実行時に環境識別子をコマンドラインの引数に指定し、引数に応じた環境作成を行う

### 実装方針
本プロジェクトでは以下の方針で環境分割を実現する。

#### 環境パラメータの管理方法
* `cdk.json` にて、パラメータファイルに環境毎パラメータを管理する。
* 各環境に対して標準化したStackを実装し、環境に応じたパラメータをファイルから読み込み、作成する環境に応じて、スタックコンストラクトに渡すパラメータを変更する。
* cdk.jsonの構造としては以下のように実装する
  * `cdk.json`構造
    | 階層 | キー                              | 設定値                                             |
    | ---- | --------------------------------- | -------------------------------------------------- |
    | 1    | context                           | コンテキストルート                                 |
    | 2    | context.{環境識別子}              | 以下の階層に環境毎のパラメータを設定               |
    | 3    | context.{環境識別子}.common       | 以下の階層にアプリケーション共通設定を設定         |
    | 3    | context.{環境識別子}.{スタック名} | 以下の階層にアプリケーションスタック固有設定を設定 |

            
  * `cdk.json`設定例
    ``` json
    "context": {
        "dev": {
            "common": {
                "region": "us-west-2",
                ...
            },
            "network": {
                "vpcCidr": "10.200.0.0/16",
                ...
            },
            "appStatefull": {
                ...
            },
            ...
        }
        "stg":{...},
        ....
    }
    ```

#### 環境切替方法
cdk contextの仕組みを利用し、CDK Deployコマンド実行時にコマンドライン変数(env)に環境識別子(dev,stg,pro,...)をコマンドラインの引数に指定することで、引数に応じた環境作成を行う
    ```sh 
    cdk deploy --all -c env=dev
        ```
#### プログラム上での実装ルール
プログラム上にて、環境パラメータを利用する場合のルールを記載する。
* プログラムからの環境識別子の取得と環境パラメータの取得は以下のようにメインプログラム(`bin/index.ts`)で`tryGetContext()`を利用する。
  ``` ts
  /** bin/index.ts */
  //環境識別子の取得
  const envKey: string = app.node.tryGetContext('env');
  //環境パラメータの取得
  const envVals = app.node.tryGetContext(envKey);
  ```
* 環境識別子の取得や環境パラメータの取得について、スタッククラス、コンストラクトクラスからの`tryGetContext()`や環境変数の取得は禁止し、必ずトップ階層(`bin/index.ts`)にて取得する。
  * スタックやコンストラクトには引数として渡すようにする。

* 秘密情報(DBのシークレット情報等)については、上述のcdk.jsonやコード内に直接指定しない
  * 秘密情報については、SecretManagerやSSM パラメータストアのSecureStringに安全に格納し、必要に応じて、cdkやアプリケーションから呼び出すものとする。
* 外だしの必要のないパラメータ（秘密情報や環境毎パラメータ以外）は定数として、スタック内に定義をしても良いものとする。
  * ただし、保守性を考え、ファンクションの先頭に定義する等分かりやすく実装すること。

## スタックの実装について
本CDKプロジェクトにおけるスタックの実装方針について記載する。
### 実装方針
#### スタック分割方針
以下のようにアプリケーションをスタック分割する。
| 生成順序 | スタック           | 内容                                                                |
| -------- | ------------------ | ------------------------------------------------------------------- |
| 1        | networkStack       | VPC等のネットワーク関連のリソースを含める。                         |
| 2        | appStatefullStack  | RDS、S3、ECR等のデータストレージ関連のリソースを含める。            |
| 3        | appConnectionStack | CloudFront、ALB等のネットワークトラフィック関連のリソースを含める。 |
| 4        | appBackendStack    | ECS等のアプリケーションバックエンド関連のリソースを含める。         |
| 5        | opsStack           | 踏み台EC2等の運用関連のリソースを含める。                           |

#### プログラム上での実装ルール
* スタックファイルは`lib/stack`フォルダに配置し、ファイル名は`*-stack.ts`として、スタッククラス1つにつき、1ファイルとして作成する。
* スタックは各環境で、共通利用する為、環境毎標準化するよう実装し、環境差異が生じる設定については、スタックのコンストラクト引数として定義する。
* スタック間でパラメータの受け渡しが必要な場合は、クラスのメンバー変数とコンストラクタ引数を利用して受け渡す。

## コンストラクトの実装について
本CDKプロジェクトにおけるコンストラクトの実装方針について記載する。
### 実装方針
#### コンストラクト分割方針
* コンストラクトに定義するリソース等については、定義はしない。ただし、再利用性や変更頻度を考慮した上で、なるべく多くのリソースを1つのコンストラクトに含められるのが望ましい。
#### プログラム上での実装ルール
* コンストラクトクラスの実装については、複数スタックから参照されることを想定し、再利用性の高い実装を検討する。
  * 設定値をコンストラクト内に埋め込まず、パラメータとしてコンストラクト利用側から設定できるようにする等を考慮する。
  * オプション的な設定については、コンストラクタで設定せず、メソッド化する等を考慮する。（コンストラクト引数の削減に繋がる）
  * 実装はなるべく、スタックでなく、コンストラクトに寄せるように実装する。
* コンストラクトファイルは`lib/construct`フォルダ以下にコンストラクト名のフォルダを配置し、その配下にファイル名を`*-construct.ts`として、コンストラクトクラス1つにつき、1ファイルとして作成する。
* コンストラクト間の呼び出しについて
  * コンストラクト同士でコンポジットを形成できるが、無制約に実装すると、コードのスパゲティ化や循環参照による保守性の低下が起こる可能性があるので、コンストラクト間の呼び出しは以下のルールにて実装を行うものとする。
    * コンストラクトからコンストラクトを呼び出す場合、同一フォルダまたは、子フォルダのコンストラクトの参照のみに制限する
    * (IAMやS3等利用頻度が高いリソースに関してはルールの考慮が必要) 

## 命名規則について
リソース名、Nameタグ値の命名ルールを記載。

### 実装方針
リソースの命名規則は基本設計書に準じた上、以下のように実装する。
#### 命名規則
* 命名ルール
  `${pjPrefix}-${serviceName}-${systemId}-${envKey}-${use}-${increment}`
* 命名要素
  | 命名要素    | 内容           |
  | ----------- | -------------- |
  | envKey      | 環境識別子     |
  | pjPrefix    | プロジェクト名 |
  | systemId    | システム識別子 |
  | increment   | 識別番号       |
  | serviceName | サービス名     |
  | use         | 用途           |
* ルール
  `ctc-vpc-sys-dev-nw-1`

#### プログラム上での実装ルール
以下の要領で命名要素の決定及び、名前生成を行う。
1. 環境固有の命名要素の決定
    * 以下の命名要素については、最上位のアプリケーションレイヤ(`bin/index.ts`)にて決定し、各スタックへ引数として渡す。
      * 命名要素
        | スタック  | 内容           |
        | --------- | -------------- |
        | envKey    | 環境識別子     |
        | pjPrefix  | プロジェクト名 |
        | systemId  | システム識別子 |
        | increment | 識別番号       |
1. スタック固有の命名要素の決定
    * 以下の命名要素についてはついては、スタッククラス内で決定する。
        | スタック    | 内容       |
        | ----------- | ---------- |
        | serviceName | サービス名 |
        | use         | 用途       |
1. 名前生成
     * スタッククラス内にて`utils/helpers.ts`の`ResourceNameBuilder.makeResourceNameStr()`を呼び出し、リソース名を生成する。(コンストラクトクラス内では生成しないこと。)
## タグについて
タグの実装方針について、記載。
### 実装方針
タグ設定のルールについては、基本設計書に準じた上、以下のように実装する。
#### CTC_Bill02_System タグ
  * スタックに対して設定し、スタック配下のコンストラクトに含まれるリソースに一括で付与する。

#### Name タグ
  * スタック、もしくは、コンストラクト内にて、リソースレベルで付与する。
  * Nameタグの命名規則は[命名規則について](#命名規則について)
      * Name タグについては、原則、命名規則に沿って全リソースに付与するが、下記については例外とする。
          * RDS インスタンス
              * RDSインスタンスについては、CDKによるNameタグ付与の制御が難しいため、Nameタグの付与はしないものとする。
          * IAM Role
              * ID、CDKによって暗黙的に作成するケースが多く、実装コストを考慮して、リソース名の固定は原則しないものとする。
          * ALB TargetGroup
              * パラメータ更新時の影響を考慮して、リソース名の固定はしないものとする。
          * Synthetics
              * Canary名は文字数制限があるため、命名規則の例外とする。
          * EventBridge のEventルール
              * CDK でタグ作成ができないため、タグ付け対象外とする。
          * VPCエンドポイント
              * CDK でタグ作成ができないため、タグ付け対象外とする。 


## スタックのRemoval Policy /削除保護　
誤削除を防ぐため、納品環境のスタック及びリソースに削除保護を設ける。  
Removal Policy /削除保護については以下に説明する。
* CDKスタックについて、スタック削除の挙動をRemoval Policy にて制御できる。
    * Removal Policyは'Destroy', 'Retain', 'Snapshot'のいずれかを選択できる。
* 一部AWSリソースについては削除保護を設定できる。

### 実装方針
* 環境識別子(env) が `ctc[0-9]`でない時は下記リソースに関して、Retain、削除保護を設定する。
    * CloudWatch Logs
    * S3 Bucket
    * RDS
    * ECR
    * ACL

## テストについて
CDKにおける自動テストの手法としては以下の2方式がある。
1. Fine-grained assertions
     * 一般的なインフラ単体テストに相当
     * リソースに想定した設定が含まれているか等をテストする
2. Snapshot tests
     * 前回構成からの差分を確認する
     * 差分の検証は合成後のCloudformationテンプレートに対して行われる。
### 実装方針
本プロジェクトのテスト自動化はSnapshot testsのみ採用する。
単体テストについてはコード化せず、手動にて別途実施するものとする。